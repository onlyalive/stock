<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="referrer" content="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      table {
        border-collapse: collapse;
        width: 100%;
      }

      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: right;
      }

      th {
        background-color: #f2f2f2;
      }

      .up {
        color: #f00;
      }
      .down {
        color: #0c0;
      }

      .edit-input {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border: 1px solid #ddd;
        padding: 0 4px;
        text-align: right;
        border-radius: 3px;
        margin: 0;
        background: transparent;
        font-size: inherit;
        line-height: inherit;
      }

      .edit-input:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 3px rgba(76, 175, 80, 0.5);
      }

      .summary-row {
        font-weight: bold;
        background-color: #f8f8f8;
      }

      table td:nth-child(7),
      table td:nth-child(8) {
        width: 100px;
        min-width: 100px;
        max-width: 100px;
        padding: 0;
      }

      td {
        height: 40px;
        padding: 0 8px;
        vertical-align: middle;
      }

      .update-btn {
        padding: 6px 12px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }

      .update-btn:hover {
        background-color: #45a049;
      }

      #manageTable {
        width: 100%;
        margin-top: 10px;
      }

      #manageTable th,
      #manageTable td {
        text-align: left;
        padding: 8px;
      }

      #manageTable button {
        margin-right: 5px;
      }

      #managePanel {
        position: fixed;
        top: 0;
        right: -500px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      }

      #managePanel.show {
        right: 0;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        padding: 5px;
        color: #666;
      }

      .close-btn:hover {
        color: #333;
      }

      #overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 999;
      }

      #overlay.show {
        display: block;
      }

      .settings-btn {
        color: #4caf50;
        background: none;
        border: none;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
      }

      .settings-btn:hover {
        transform: rotate(45deg);
      }
    </style>
  </head>
  <body>
    <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center">
      <div>
        <span>数据自动更新中...</span>
      </div>
      <div style="display: flex; align-items: center; gap: 20px">
        <div id="currentTime" style="font-size: 14px"></div>
        <button class="settings-btn" onclick="fetchStockData()">⟳</button>
        <button class="settings-btn" onclick="showManagePanel()">⋮</button>
      </div>
    </div>

    <div id="overlay"></div>

    <div id="managePanel">
      <div class="panel-header">
        <h3>股票管理</h3>
        <button class="close-btn" onclick="showManagePanel()">&times;</button>
      </div>
      <div style="margin-bottom: 20px">
        <button class="update-btn" onclick="addNewStock()">添加新股票</button>
      </div>
      <table id="manageTable">
        <thead>
          <tr>
            <th>代码</th>
            <th>成本</th>
            <th>持仓</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="manageTableBody"></tbody>
      </table>
    </div>

    <table>
      <thead>
        <tr>
          <th>代码</th>
          <th>名称</th>
          <th>现价</th>
          <th>昨收</th>
          <th>涨跌额</th>
          <th>涨跌幅(%)</th>
          <th>成本</th>
          <th>持仓</th>
          <th>单日盈亏</th>
          <th>累计盈亏</th>
        </tr>
      </thead>
      <tbody id="stockTableBody">
        <!-- 数据将通过JavaScript动态填充 -->
      </tbody>
    </table>

    <script>
      // 股票配置数据
      const stockConfig = {
        cost: [0, 31.783, 51.113, 38.088, 1.018],
        position: [0, 2000, 400, 600, 20000],
        secids: "1.000001, 1.601633, 0.002230, 0.002864, 1.588080",
        fields: "f12,f14,f2,f18,f4,f3",
      };

      // 添加交易时间判断函数
      function isTradeTime() {
        const now = new Date();
        const day = now.getDay();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const currentTime = hours * 100 + minutes;

        // 周末不交易
        if (day === 0 || day === 6) {
          return false;
        }

        // 交易时间：9:30-12:00, 13:00-15:30
        return (
          (currentTime >= 900 && currentTime <= 1130) ||
          (currentTime >= 1300 && currentTime <= 1530)
        );
      }

      async function fetchStockData() {
        try {
          // 检查是否在交易时间
          if (!isTradeTime()) {
            // 非交易时间，延长刷新间隔到10分钟
            setTimeout(fetchStockData, 600000);
            return;
          }

          const url = `https://push2.eastmoney.com/api/qt/ulist.np/get?fltt=2&fields=${stockConfig.fields}&secids=${stockConfig.secids}`;
          const response = await axios.get(url);
          const data = response.data;

          if (data && data.data && data.data.diff) {
            // 转换数据为股票列表
            const stockList = data.data.diff.map((item, index) => {
              return {
                code: item.f12,
                name: item.f14,
                price: item.f2,
                cost: stockConfig.cost[index],
                yesterdayClose: item.f18,
                change: item.f4,
                changePercent: item.f3,
                position: stockConfig.position[index],
                profit: (item.f4 * stockConfig.position[index]).toFixed(2),
                totalProfit: (
                  (item.f2 - stockConfig.cost[index]) *
                  stockConfig.position[index]
                ).toFixed(2),
              };
            });

            // 计算总盈亏
            const todayProfit = stockList.reduce((sum, stock) => sum + Number(stock.profit), 0);
            const allProfit = stockList.reduce((sum, stock) => sum + Number(stock.totalProfit), 0);

            // 更新表格内容
            updateTableContent(stockList, todayProfit, allProfit);
          }

          // 交易时间内3秒刷新一次
          setTimeout(fetchStockData, 3000);
        } catch (error) {
          console.error("获取股票数据失败:", error);
          setTimeout(fetchStockData, 3000);
        }
      }

      function upOrDown(val) {
        return val > 0 ? "up" : val < 0 ? "down" : "";
      }

      function updateTableContent(stockList, todayProfit, allProfit) {
        const tbody = document.getElementById("stockTableBody");

        // 获取保存的设置
        const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");

        // 生成股票数据行
        const stockRows = stockList
          .map((stock, index) => {
            // 使用保存的成本和持仓数据（如果有的话）
            const savedCost = savedData.cost?.[index] || stock.cost;
            const savedPosition = savedData.position?.[index] || stock.position;

            return `
          <tr>
            <td>${stock.code}</td>
            <td>${stock.name}</td>
            <td>${stock.price}</td>
            <td>${stock.yesterdayClose}</td>
            <td class="${upOrDown(stock.change)}">${stock.change}</td>
            <td class="${upOrDown(stock.changePercent)}">${stock.changePercent}%</td>
            <td class="editable">${savedCost}</td>
            <td class="editable">${savedPosition}</td>
            <td class="${upOrDown(stock.profit)}">${stock.profit}</td>
            <td class="${upOrDown(stock.totalProfit)}">${stock.totalProfit}</td>
          </tr>
        `;
          })
          .join("");

        // 添加汇总行
        const summaryRow = `
        <tr class="summary-row">
          <td colspan="8">汇总</td>
          <td class="${upOrDown(todayProfit)}">${todayProfit.toFixed(2)}</td>
          <td class="${upOrDown(allProfit)}">${allProfit.toFixed(2)}</td>
        </tr>
      `;

        // 更新表格内容
        tbody.innerHTML = stockRows + summaryRow;

        // 重新添加编辑功能
        addEditableFeatures();
      }

      function addEditableFeatures() {
        document.querySelectorAll("tbody tr:not(.summary-row)").forEach((row, index) => {
          // 成本单元格
          const costCell = row.cells[6];
          costCell.onclick = () => makeEditable(costCell, index, "cost");

          // 持仓单元格
          const positionCell = row.cells[7];
          positionCell.onclick = () => makeEditable(positionCell, index, "position");
        });
      }

      function makeEditable(cell, index, field) {
        if (cell.querySelector("input")) return;

        const originalValue = cell.textContent;
        const input = document.createElement("input");
        input.type = "number";
        input.value = originalValue;
        input.className = "edit-input";

        input.onblur = function () {
          const newValue = this.value;
          cell.textContent = newValue;

          // 保存到 localStorage
          const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");
          if (!savedData[field]) savedData[field] = [];
          savedData[field][index] = parseFloat(newValue);
          localStorage.setItem("stockSettings", JSON.stringify(savedData));

          // 更新 stockConfig
          stockConfig[field][index] = parseFloat(newValue);

          // 重新计算盈亏
          recalculateProfit();
        };

        input.onkeydown = function (e) {
          if (e.key === "Enter") {
            this.blur();
          }
        };

        cell.textContent = "";
        cell.appendChild(input);
        input.focus();
      }

      function recalculateProfit() {
        const rows = Array.from(document.querySelectorAll("tbody tr:not(.summary-row)"));

        let todayProfit = 0;
        let allProfit = 0;

        rows.forEach((row) => {
          const price = parseFloat(row.cells[2].textContent);
          const cost = parseFloat(row.cells[6].textContent);
          const position = parseFloat(row.cells[7].textContent);
          const change = parseFloat(row.cells[4].textContent);

          const dailyProfit = change * position;
          const totalProfit = (price - cost) * position;

          row.cells[8].textContent = dailyProfit.toFixed(2);
          row.cells[9].textContent = totalProfit.toFixed(2);

          // 更新颜色
          row.cells[8].className = upOrDown(dailyProfit);
          row.cells[9].className = upOrDown(totalProfit);

          todayProfit += dailyProfit;
          allProfit += totalProfit;
        });

        // 更新汇总行
        const summaryRow = document.querySelector(".summary-row");
        if (summaryRow) {
          summaryRow.cells[1].textContent = todayProfit.toFixed(2);
          summaryRow.cells[1].className = upOrDown(todayProfit);
          summaryRow.cells[2].textContent = allProfit.toFixed(2);
          summaryRow.cells[2].className = upOrDown(allProfit);
        }
      }

      function showManagePanel() {
        const panel = document.getElementById("managePanel");
        const overlay = document.getElementById("overlay");

        if (panel.classList.contains("show")) {
          panel.classList.remove("show");
          overlay.classList.remove("show");
          // 启用页面滚动
          document.body.style.overflow = "";
        } else {
          panel.classList.add("show");
          overlay.classList.add("show");
          updateManageTable();
          // 禁用页面滚动
          document.body.style.overflow = "hidden";
        }
      }

      function updateManageTable() {
        const tbody = document.getElementById("manageTableBody");
        const secidsArray = stockConfig.secids.split(",").map((s) => s.trim());

        const rows = secidsArray
          .map(
            (secid, index) => `
          <tr>
            <td>${secid}</td>
            <td>${stockConfig.cost[index]}</td>
            <td>${stockConfig.position[index]}</td>
            <td>
              <button class="update-btn" onclick="editStock(${index})">编辑</button>
              <button class="update-btn" style="background-color: #f44336" onclick="deleteStock(${index})">删除</button>
            </td>
          </tr>
        `
          )
          .join("");

        tbody.innerHTML = rows;
      }

      function addNewStock() {
        // 创建弹窗
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.top = "50%";
        modal.style.left = "50%";
        modal.style.transform = "translate(-50%, -50%)";
        modal.style.backgroundColor = "white";
        modal.style.padding = "20px";
        modal.style.boxShadow = "0 0 10px rgba(0,0,0,0.5)";
        modal.style.zIndex = "1001";

        // 创建搜索框
        const searchInput = document.createElement("input");
        searchInput.type = "text";
        searchInput.placeholder = "输入股票代码";
        modal.appendChild(searchInput);

        // 创建搜索按钮
        const searchButton = document.createElement("button");
        searchButton.textContent = "搜索";
        searchButton.onclick = async function () {
          const code = searchInput.value.trim();
          if (!code) return;
            try {
              const url = `https://api.codelife.cc/stock/search?lang=cn&name=${code}`;
              const response = await axios.get(url);
              const data = response.data;
              console.log('response', response);

              if (data && data.data) {
                // 清空之前的搜索结果
                resultTable.innerHTML = '';

                // 显示搜索结果
                data.data.forEach(stock => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
                    <td><input type="checkbox" value="${stock.code}"></td>
                    <td>${stock.name}</td>
                    <td>${stock.code}</td>
                  `;
                  resultTable.appendChild(row);
                });
              } else {
                alert('未找到相关股票');
              }
            } catch (error) {
              console.error('搜索股票失败:', error);
              alert('搜索股票失败');
            }
        };
        modal.appendChild(searchButton);

        // 创建结果表格
        const resultTable = document.createElement("table");
        resultTable.innerHTML = `
          <thead>
            <tr>
              <th>选择</th>
              <th>名称</th>
              <th>代码</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        modal.appendChild(resultTable);

        // 创建确认按钮
        const confirmButton = document.createElement("button");
        confirmButton.textContent = "确认";
        confirmButton.onclick = function () {
          const selectedStocks = Array.from(
            resultTable.querySelectorAll('input[type="checkbox"]:checked')
          ).map((input) => input.value);

          if (selectedStocks.length === 0) {
            alert("请选择至少一个股票");
            return;
          }

          selectedStocks.forEach((code) => {
            const cost = prompt("请输入成本价：");
            if (!cost) return;

            const position = prompt("请输入持仓数：");
            if (!position) return;

            const secidsArray = stockConfig.secids.split(",").map((s) => s.trim());
            secidsArray.push(code);
            stockConfig.secids = secidsArray.join(", ");
            stockConfig.cost.push(parseFloat(cost));
            stockConfig.position.push(parseInt(position));
          });

          // 保存到 localStorage
          const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");
          savedData.cost = stockConfig.cost;
          savedData.position = stockConfig.position;
          savedData.secids = stockConfig.secids;
          localStorage.setItem("stockSettings", JSON.stringify(savedData));

          updateManageTable();
          fetchStockData(); // 刷新数据

          // 关闭弹窗
          document.body.removeChild(modal);
        };
        modal.appendChild(confirmButton);

        // 添加弹窗到页面
        document.body.appendChild(modal);
      }

      function editStock(index) {
        const secidsArray = stockConfig.secids.split(",").map((s) => s.trim());

        const code = prompt("请输入股票代码：", secidsArray[index]);
        if (!code) return;

        const cost = prompt("请输入成本价：", stockConfig.cost[index]);
        if (!cost) return;

        const position = prompt("请输入持仓数：", stockConfig.position[index]);
        if (!position) return;

        secidsArray[index] = code;
        stockConfig.secids = secidsArray.join(", ");
        stockConfig.cost[index] = parseFloat(cost);
        stockConfig.position[index] = parseInt(position);

        // 保存到 localStorage
        const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");
        savedData.cost = stockConfig.cost;
        savedData.position = stockConfig.position;
        savedData.secids = stockConfig.secids;
        localStorage.setItem("stockSettings", JSON.stringify(savedData));

        updateManageTable();
        fetchStockData(); // 刷新数据
      }

      function deleteStock(index) {
        if (!confirm("确定要删除这支股票吗？")) return;

        const secidsArray = stockConfig.secids.split(",").map((s) => s.trim());
        secidsArray.splice(index, 1);
        stockConfig.secids = secidsArray.join(", ");
        stockConfig.cost.splice(index, 1);
        stockConfig.position.splice(index, 1);

        // 保存到 localStorage
        const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");
        savedData.cost = stockConfig.cost;
        savedData.position = stockConfig.position;
        savedData.secids = stockConfig.secids;
        localStorage.setItem("stockSettings", JSON.stringify(savedData));

        updateManageTable();
        fetchStockData(); // 刷新数据
      }

      window.onload = function () {
        const savedData = JSON.parse(localStorage.getItem("stockSettings") || "{}");
        if (savedData.cost) stockConfig.cost = savedData.cost;
        if (savedData.position) stockConfig.position = savedData.position;
        if (savedData.secids) stockConfig.secids = savedData.secids;

        // 启动自动刷新
        fetchStockData();

        // 更新时间显示
        function updateCurrentTime() {
          const now = new Date();
          const timeString = now.toLocaleString();
          const trading = isTradeTime();
          document.getElementById("currentTime").textContent = `${timeString} ${
            trading ? "(交易中)" : "(非交易时间)"
          }`;
        }

        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
      };

      // 添加点击遮罩层关闭面板的功能
      document.getElementById("overlay").addEventListener("click", function () {
        showManagePanel();
      });
    </script>
  </body>
</html>
